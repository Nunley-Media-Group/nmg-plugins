# File: .claude/specs/feature-per-step-model-effort-config/feature.gherkin
#
# Generated from: .claude/specs/feature-per-step-model-effort-config/requirements.md
# Issues: #77, #91

Feature: Per-step model and effort level configuration
  As a developer or OpenClaw automation agent running the SDLC workflow
  I want per-step model and effort level configuration
  So that each SDLC phase uses the optimal model for its task

  # --- Runner Per-Step Model ---

  Scenario: Per-step model override in runner config
    Given a sdlc-config.json with global model "sonnet"
    And the writeSpecs step has model "opus"
    When the runner executes the writeSpecs step
    Then the claude subprocess is invoked with "--model opus"

  Scenario: Global model used as fallback when step has no model override
    Given a sdlc-config.json with global model "sonnet"
    And the startIssue step has no model field
    When the runner executes the startIssue step
    Then the claude subprocess is invoked with "--model sonnet"

  Scenario: Default model used when neither step nor global specifies model
    Given a sdlc-config.json with no global model field
    And no step has a model field
    When the runner executes any step
    Then the claude subprocess is invoked with "--model opus"

  # --- Runner Per-Step Effort ---

  Scenario: Per-step effort override in runner config
    Given a sdlc-config.json with global effort "high"
    And the startIssue step has effort "medium"
    When the runner executes the startIssue step
    Then the subprocess environment includes CLAUDE_CODE_EFFORT_LEVEL set to "medium"

  Scenario: Global effort used as fallback when step has no effort override
    Given a sdlc-config.json with global effort "high"
    And the writeSpecs step has no effort field
    When the runner executes the writeSpecs step
    Then the subprocess environment includes CLAUDE_CODE_EFFORT_LEVEL set to "high"

  Scenario: No effort env var set when neither step nor global specifies effort
    Given a sdlc-config.json with no global effort field
    And no step has an effort field
    When the runner executes any step
    Then the subprocess environment does not include CLAUDE_CODE_EFFORT_LEVEL

  # --- Implement Step: Single Invocation (AC10, supersedes old plan/code split) ---
  # Added by issue #91

  Scenario: Implement step uses single runClaude invocation
    Given a sdlc-config.json with implement step configured
    When the runner executes the implement step
    Then a single runClaude call is made
    And no runImplementStep function is called
    And the subprocess uses the step-level model and effort configuration

  Scenario: Implement step defaults to opus model and medium effort
    Given a sdlc-config.json with no implement-level model or effort overrides
    And no global model or effort overrides
    When the runner resolves the implement step configuration
    Then the model defaults to "opus"
    And the effort defaults to "medium"

  Scenario: Implement step prompt omits EnterPlanMode instruction
    Given the runner builds the prompt for step 4
    When the prompt is constructed
    Then it does not contain "Do NOT call EnterPlanMode"
    And it does not reference EnterPlanMode in any form

  # --- Backward Compatibility ---

  Scenario: Backward compatibility with config lacking per-step overrides
    Given a sdlc-config.json with only global model "opus" and no per-step model or effort fields
    When the runner executes the writeSpecs step
    Then the claude subprocess is invoked with "--model opus"
    And the subprocess environment does not include CLAUDE_CODE_EFFORT_LEVEL

  # Added by issue #91
  Scenario: Legacy plan/code config is silently ignored
    Given a sdlc-config.json with plan and code sub-objects under steps.implement
    When the runner validates the config
    Then no validation errors are raised for the plan and code sub-objects
    And the step-level implement.model and implement.effort are used for resolution

  # --- Config Template ---

  # Added by issue #91 (supersedes old config template scenario)
  Scenario: Config template shows flat implement config
    Given a user reads sdlc-config.example.json
    When they review the implement step configuration
    Then the implement step has a flat config with model "opus" and effort "medium"
    And there are no nested plan or code sub-objects

  # Added by issue #91
  Scenario: Config template shows createPR maxTurns of 30
    Given a user reads sdlc-config.example.json
    When they review the createPR step configuration
    Then maxTurns is 30

  # --- Skill Frontmatter ---

  Scenario: Skill frontmatter includes model field
    Given any nmg-sdlc SKILL.md file
    When Claude Code loads it for manual invocation
    Then the YAML frontmatter contains a model field
    And the model matches the recommended default for that skill

  Scenario Outline: Each skill has the correct model in frontmatter
    Given the SKILL.md for <skill>
    When the frontmatter is parsed
    Then the model field is <model>

    Examples:
      | skill                    | model  |
      | creating-issues          | sonnet |
      | creating-prs             | sonnet |
      | generating-openclaw-config | sonnet |
      | implementing-specs       | opus   |
      | installing-openclaw-skill | sonnet |
      | migrating-projects       | opus   |
      | running-retrospectives   | opus   |
      | setting-up-steering      | opus   |
      | starting-issues          | sonnet |
      | verifying-specs          | sonnet |
      | writing-specs            | opus   |

  # --- Writing-Specs Auto-Mode Fix ---
  # Added by issue #91

  Scenario: Writing-specs auto-mode always amends existing spec
    Given auto-mode is active
    And spec discovery finds a matching existing feature spec
    When the skill decides whether to amend or create
    Then it proceeds directly in amendment mode without calling AskUserQuestion

  # --- README Documentation ---

  Scenario: README documents model and effort recommendations
    Given a user reads the README
    When they look for model and effort guidance
    Then they find a table of recommended model and effort settings per skill
    And instructions for overriding defaults via runner config

  # --- Config Validation ---

  Scenario: Invalid effort value is rejected at startup
    Given a sdlc-config.json with effort value "maximum"
    When the runner starts
    Then it exits with a non-zero exit code
    And the error message identifies the invalid effort value
    And the error message lists valid options: "low", "medium", "high"

  Scenario: Empty model value is rejected at startup
    Given a sdlc-config.json with model value ""
    When the runner starts
    Then it exits with a non-zero exit code
    And the error message identifies the invalid model value

  # --- Migrating Projects ---

  Scenario: Migration detects new config keys after plugin upgrade
    Given a project with an old-format sdlc-config.json lacking model and effort fields
    When the user runs /migrating-projects after upgrading the plugin
    Then the migration proposes adding the missing model and effort keys
    And existing config values are preserved
