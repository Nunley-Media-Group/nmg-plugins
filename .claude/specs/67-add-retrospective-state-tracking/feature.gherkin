# File: .claude/specs/67-add-retrospective-state-tracking/feature.gherkin
#
# Generated from: .claude/specs/67-add-retrospective-state-tracking/requirements.md
# Issue: #67

Feature: Retrospective State Tracking and Deduplication
  As a spec author (human or OpenClaw automation agent)
  I want the retrospectives skill to track analyzed defect specs and skip unchanged ones
  So that retrospective runs are efficient and never produce duplicate learnings

  # --- Happy Path ---

  Scenario: State file created on first run
    Given no ".claude/steering/retrospective-state.json" exists
    And defect specs with Related Spec links exist in ".claude/specs/"
    When the retrospectives skill completes a run
    Then a "retrospective-state.json" is written to ".claude/steering/"
    And it contains an entry for each analyzed defect spec
    And each entry includes the spec's file path, content hash, and analysis date

  Scenario: Unchanged specs are skipped on subsequent runs
    Given a "retrospective-state.json" exists with hashes from a previous run
    And 3 defect specs have not changed since that run
    And 2 defect specs have been modified
    When the retrospectives skill runs again
    Then the 3 unchanged defect specs are not re-analyzed
    And their existing learnings are preserved in the output
    And only the 2 modified specs are re-analyzed

  Scenario: Modified specs are re-analyzed
    Given a "retrospective-state.json" exists with a hash for a defect spec
    And that defect spec's content has changed since the last run
    When the retrospectives skill runs again
    Then the modified spec is re-analyzed
    And its hash is updated in the state file
    And its learnings reflect the updated content

  Scenario: New specs are analyzed and added to state
    Given a "retrospective-state.json" exists from a previous run with 5 entries
    And a new defect spec has been added to ".claude/specs/"
    When the retrospectives skill runs again
    Then the new spec is analyzed
    And a new entry is added to the state file
    And the state file now contains 6 entries

  # --- Cleanup ---

  Scenario: Deleted specs are cleaned up from state
    Given a "retrospective-state.json" references a defect spec at ".claude/specs/99-old-bug/"
    And that spec directory no longer exists on disk
    When the retrospectives skill runs again
    Then the entry for ".claude/specs/99-old-bug/" is removed from the state file
    And learnings sourced solely from that deleted spec are removed from the retrospective

  # --- Deduplication ---

  Scenario: Near-duplicate learnings are merged
    Given the skill has completed analysis of new and modified specs
    And carried-forward learnings from unchanged specs are included
    When the aggregation pass runs on the combined set
    Then no two learnings in the output have overlapping core patterns
    And near-duplicate learnings are merged with combined evidence references

  # --- State File Format ---

  Scenario: State file is valid JSON with required fields
    Given the retrospectives skill completes successfully
    When "retrospective-state.json" is written
    Then the file contains valid JSON
    And the JSON has a "version" field set to 1
    And the JSON has a "specs" object mapping paths to entries
    And each entry has a "hash" string and a "lastAnalyzed" date string

  # --- Error Handling ---

  Scenario: Graceful degradation with malformed state file
    Given a "retrospective-state.json" exists but contains invalid JSON
    When the retrospectives skill runs
    Then a warning is logged about the corrupt state file
    And a full re-analysis is performed as if no state file exists
    And a valid state file is written upon completion

  # --- Output Summary ---

  Scenario: Output summary distinguishes new vs carried-forward learnings
    Given the skill completes with both newly analyzed and unchanged specs
    When the output summary is displayed
    Then the summary shows the total defect spec count
    And the summary shows the breakdown of new, modified, skipped, and removed specs
    And the summary shows the count of new learnings vs carried-forward learnings

  # --- Hash Computation ---

  Scenario: Content hash is computed before analysis begins
    Given a defect spec is eligible for analysis
    When the skill processes the spec
    Then a SHA-256 hash is computed from the spec's requirements.md content
    And this hash is compared against the stored hash before deciding whether to analyze
