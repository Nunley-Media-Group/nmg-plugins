# File: .claude/specs/72-feature-centric-spec-management/feature.gherkin
#
# Generated from: .claude/specs/72-feature-centric-spec-management/requirements.md
# Issue: #72

Feature: Feature-Centric Spec Management
  As a developer using the nmg-sdlc workflow
  I want enhancement specs to amend existing feature specs rather than creating duplicates
  So that each feature has a single canonical spec that evolves over time

  # --- Spec Discovery and Amendment ---

  Scenario: Writing-Specs detects and amends existing feature spec
    Given an enhancement issue "#71" titled "Add dark mode toggle to settings" exists
    And a spec directory "feature-dark-mode" already exists with requirements.md tracking issue "#42"
    When the user runs "/writing-specs #71"
    Then the skill extracts keywords "dark", "mode", "toggle", "settings" from the issue title
    And searches ".claude/specs/feature-*/requirements.md" for keyword matches
    And finds "feature-dark-mode" as the top match
    And presents the match for user confirmation: "Amend existing spec?" or "Create new spec"
    And upon confirmation, amends the existing spec with new requirements
    And adds "#71" to the Issues frontmatter: "**Issues**: #42, #71"
    And adds an entry to the Change History section

  Scenario: Writing-Specs creates new feature spec when no match exists
    Given a feature issue "#80" titled "Add weather alerts" exists
    And no existing spec directory contains keywords matching "weather" or "alerts"
    When the user runs "/writing-specs #80"
    Then the skill searches existing feature specs and finds no match
    And creates a new spec directory named "feature-weather-alerts"
    And the spec frontmatter reads "**Issues**: #80"
    And the Change History section contains one entry for issue "#80"

  Scenario: User rejects spec match and creates new spec
    Given an enhancement issue "#71" titled "Add dark mode toggle to settings" exists
    And the skill finds "feature-dark-mode" as a potential match
    When the user is asked to confirm the match
    And the user selects "Create new spec"
    Then a new spec directory "feature-add-dark-mode-toggle-to-settings" is created
    And the existing "feature-dark-mode" spec is left unchanged

  # --- Naming Convention ---

  Scenario: Feature spec directories use feature- prefix
    Given a feature issue "#80" titled "Add weather alerts" exists
    And the issue does not have the "bug" label
    When the user runs "/writing-specs #80"
    Then the spec directory is named "feature-weather-alerts"
    And the directory name contains no issue number
    And the issue number is tracked only in the spec frontmatter

  Scenario: Bug spec directories use bug- prefix
    Given a bug issue "#90" titled "Fix login crash on timeout" exists
    And the issue has the "bug" label
    When the user runs "/writing-specs #90"
    Then the spec directory is created as "bug-login-crash-on-timeout"
    And the directory uses the "bug-" prefix with the issue title slug
    And no spec discovery search is performed for existing specs

  # --- Multi-Issue Frontmatter ---

  Scenario: Multi-issue frontmatter tracking
    Given a spec "feature-dark-mode" has been amended by issues "#42", "#71", and "#85"
    When the spec files are read
    Then the Issues field reads "**Issues**: #42, #71, #85"
    And the Change History section has three entries
    And each entry shows the issue number, date, and summary of contribution

  # --- Spec Discovery Strategy ---

  Scenario: Spec match discovery uses concrete search strategy
    Given an issue titled "Add dark mode toggle to settings"
    And the keyword extraction filters stop words "add", "to"
    When the skill searches for existing related specs
    Then it runs Glob for ".claude/specs/feature-*/requirements.md"
    And runs Grep over each candidate using keywords "dark", "mode", "toggle", "settings"
    And scores matches by total keyword hit count
    And presents the top match to the user

  # --- Amendment Content Preservation ---

  Scenario: Amendment preserves existing content
    Given a spec "feature-dark-mode" has 3 existing ACs (AC1-AC3) and 4 FRs (FR1-FR4)
    When the spec is amended with issue "#71" adding 2 new ACs and 1 new FR
    Then the existing AC1-AC3 are unchanged
    And new criteria are numbered AC4 and AC5
    And the existing FR1-FR4 are unchanged
    And the new FR is numbered FR5
    And new Gherkin scenarios are appended to feature.gherkin with "# Added by issue #71"

  # --- Migrating-Projects Consolidation ---

  Scenario: Migrating-Projects consolidates legacy specs
    Given legacy spec directories "42-add-dark-mode" and "71-dark-mode-toggle" exist
    And both contain keywords matching "dark" and "mode"
    When the user runs "/migrating-projects"
    Then the skill detects both as legacy format specs
    And clusters them as related to the same feature
    And presents a consolidation candidate: merge into "feature-dark-mode"
    And upon user confirmation, creates "feature-dark-mode" with merged content
    And the merged Issues field reads "**Issues**: #42, #71"
    And the legacy directories are removed

  Scenario: Migrating-Projects requires confirmation per consolidation
    Given consolidation candidates for "dark-mode" and "weather-alerts" are identified
    When the user approves "dark-mode" consolidation but rejects "weather-alerts"
    Then "feature-dark-mode" is created from the merged specs
    And the "weather-alerts" legacy specs are left unchanged

  Scenario: Migrating-Projects handles already-implemented specs
    Given legacy spec "42-add-dark-mode" has all tasks marked as completed
    And legacy spec "71-dark-mode-toggle" has tasks in progress
    When the specs are consolidated into "feature-dark-mode"
    Then tasks from "42-add-dark-mode" are marked as completed in the merged tasks.md
    And the Change History notes the implementation status

  # --- Cross-Reference Updates ---

  Scenario: Defect spec cross-references updated during consolidation
    Given a defect spec "bug-login-crash" has Related Spec pointing to "42-add-auth"
    And "42-add-auth" is being consolidated into "feature-add-auth"
    When consolidation completes
    Then "bug-login-crash" Related Spec field is updated to ".claude/specs/feature-add-auth/"
    And chain resolution follows Related Spec links through intermediate defect specs
    And circular references are detected via a visited set

  # --- Frontmatter Migration ---

  Scenario: Migrating-Projects updates legacy frontmatter in feature specs
    Given a feature spec "feature-dark-mode/requirements.md" exists with heading "# Requirements: Dark Mode"
    And the file contains singular "**Issue**: #42" frontmatter
    And the file has no "## Change History" section
    When the user runs "/migrating-projects"
    Then the skill detects the singular Issue field in a feature-variant spec
    And proposes updating to "**Issues**: #42"
    And proposes adding a Change History section with initial entry for "#42"
    And upon user confirmation, applies both changes
    And defect specs with "# Defect Report:" heading are left unchanged

  # --- Downstream Compatibility ---

  Scenario: Downstream skills work with new naming convention
    Given specs exist at ".claude/specs/feature-dark-mode/requirements.md"
    And the Issues frontmatter reads "**Issues**: #42, #71"
    When "/implementing-specs #42" is run
    Then the skill resolves the spec path by searching Issues frontmatter for "#42"
    And successfully reads all spec files from the feature-prefixed directory

  # --- Auto-Mode ---

  Scenario: Auto-mode skips interactive confirmations in writing-specs
    Given ".claude/auto-mode" exists in the project directory
    And "/writing-specs #71" finds a matching spec "feature-dark-mode"
    When the spec discovery step runs
    Then amendment is auto-approved without calling AskUserQuestion
    And the spec is amended with the new issue's requirements
