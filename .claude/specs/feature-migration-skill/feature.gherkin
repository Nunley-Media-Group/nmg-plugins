# File: .claude/specs/feature-migration-skill/feature.gherkin
#
# Generated from: .claude/specs/feature-migration-skill/requirements.md
# Issues: #25, #72, #95

Feature: Project Migration Skill
  As a developer using the nmg-sdlc plugin
  I want a migration skill that updates my project's files to latest standards
  So that I benefit from new template sections without manually diffing templates

  # --- Happy Path ---

  Scenario: Steering doc migration adds missing sections
    Given a project with a "product.md" steering doc missing the "Product Principles" section
    And the latest "setting-up-steering" template includes a "Product Principles" section
    When I run "/migrating-projects"
    Then the "Product Principles" section is identified as missing
    And the section is inserted after "Core Value Proposition" with template placeholder content
    And all existing user-written content in "product.md" remains unchanged

  Scenario: Spec migration adds missing sections
    Given a project with a "requirements.md" spec missing "Non-Functional Requirements" and "UI/UX Requirements"
    And the latest "writing-specs" template includes both sections
    When I run "/migrating-projects"
    Then both missing sections are identified
    And each section is inserted at the correct position per template order
    And all existing acceptance criteria and functional requirements remain unchanged

  Scenario: User content is preserved during migration
    Given a "tech.md" steering doc with a filled-in Technology Stack table listing project-specific technologies
    And the latest template includes a new "Claude Code Resource Development" section
    When the migration adds the new section
    Then the Technology Stack table content is identical before and after migration
    And no existing content is modified or reordered

  # --- Alternative Paths ---

  Scenario: Interactive review before apply
    Given the migration analysis has identified missing sections in 3 files
    When the analysis is complete
    Then a per-file summary of proposed additions is presented
    And I can review each proposed change
    And no files are modified until I approve the migration

  Scenario: User rejects migration
    Given the migration analysis has identified proposed changes
    When I reject the migration at the review gate
    Then no files are modified
    And the skill reports that migration was cancelled

  Scenario: Self-updating template detection
    Given the plugin's "requirements.md" template has been updated with a new "Risk Assessment" section
    And the migration skill has not been modified
    When I run "/migrating-projects"
    Then the new "Risk Assessment" section is detected as missing from existing specs
    And the skill proposes adding it without any code changes to the skill itself

  Scenario: OpenClaw config migration merges missing keys
    Given a project with an "sdlc-config.json" missing the "cleanup" key and a new "merge" step
    And the latest "sdlc-config.example.json" template includes both
    When I run "/migrating-projects"
    Then the "cleanup" key is added with template default values
    And the "merge" step is added to the "steps" object
    And existing user values for "projectPath" and "discordChannelId" are preserved

  Scenario: OpenClaw skill version check warns when outdated
    Given the OpenClaw "running-sdlc" skill is installed at "~/.openclaw/skills/running-sdlc/"
    And the installed SKILL.md differs from the source in the marketplace clone
    When I run "/migrating-projects"
    Then a warning is displayed indicating the installed skill is outdated
    And the warning suggests running "/installing-openclaw-skill" to update

  # --- Edge Cases ---

  Scenario: All files already up to date
    Given all steering docs match the latest template structure
    And all spec files match the latest template structure
    And the "sdlc-config.json" has all current keys
    When I run "/migrating-projects"
    Then the skill reports "everything is up to date"
    And no files are modified

  Scenario: Missing project files are skipped
    Given a project with "product.md" but no "structure.md" in ".claude/steering/"
    And no ".claude/specs/" directory exists
    When I run "/migrating-projects"
    Then only "product.md" is analyzed for migration
    And missing files are not created
    And the summary notes that "/setting-up-steering" or "/writing-specs" can create missing files

  Scenario: Defect spec variant is correctly detected
    Given a spec directory with a "requirements.md" starting with "# Defect Report:"
    And the latest defect template variant includes a new section
    When I run "/migrating-projects"
    Then the defect template variant is used for comparison instead of the feature variant
    And the missing section from the defect variant is proposed for insertion

  Scenario: Feature spec variant is correctly detected
    Given a spec directory with a "requirements.md" starting with "# Requirements:"
    And the latest feature template includes a new section
    When I run "/migrating-projects"
    Then the feature template variant is used for comparison
    And the missing section from the feature variant is proposed for insertion

  # From issue #72

  # --- Spec Discovery and Amendment ---

  Scenario: Writing-Specs detects and amends existing feature spec
    Given an enhancement issue "#71" titled "Add dark mode toggle to settings" exists
    And a spec directory "feature-dark-mode" already exists with requirements.md tracking issue "#42"
    When the user runs "/writing-specs #71"
    Then the skill extracts keywords "dark", "mode", "toggle", "settings" from the issue title
    And searches ".claude/specs/feature-*/requirements.md" for keyword matches
    And finds "feature-dark-mode" as the top match
    And presents the match for user confirmation: "Amend existing spec?" or "Create new spec"
    And upon confirmation, amends the existing spec with new requirements
    And adds "#71" to the Issues frontmatter: "**Issues**: #42, #71"
    And adds an entry to the Change History section

  Scenario: Writing-Specs creates new feature spec when no match exists
    Given a feature issue "#80" titled "Add weather alerts" exists
    And no existing spec directory contains keywords matching "weather" or "alerts"
    When the user runs "/writing-specs #80"
    Then the skill searches existing feature specs and finds no match
    And creates a new spec directory named "feature-weather-alerts"
    And the spec frontmatter reads "**Issues**: #80"
    And the Change History section contains one entry for issue "#80"

  Scenario: User rejects spec match and creates new spec
    Given an enhancement issue "#71" titled "Add dark mode toggle to settings" exists
    And the skill finds "feature-dark-mode" as a potential match
    When the user is asked to confirm the match
    And the user selects "Create new spec"
    Then a new spec directory "feature-add-dark-mode-toggle-to-settings" is created
    And the existing "feature-dark-mode" spec is left unchanged

  # --- Naming Convention ---

  Scenario: Feature spec directories use feature- prefix
    Given a feature issue "#80" titled "Add weather alerts" exists
    And the issue does not have the "bug" label
    When the user runs "/writing-specs #80"
    Then the spec directory is named "feature-weather-alerts"
    And the directory name contains no issue number
    And the issue number is tracked only in the spec frontmatter

  Scenario: Bug spec directories use bug- prefix
    Given a bug issue "#90" titled "Fix login crash on timeout" exists
    And the issue has the "bug" label
    When the user runs "/writing-specs #90"
    Then the spec directory is created as "bug-login-crash-on-timeout"
    And the directory uses the "bug-" prefix with the issue title slug
    And no spec discovery search is performed for existing specs

  # --- Multi-Issue Frontmatter ---

  Scenario: Multi-issue frontmatter tracking
    Given a spec "feature-dark-mode" has been amended by issues "#42", "#71", and "#85"
    When the spec files are read
    Then the Issues field reads "**Issues**: #42, #71, #85"
    And the Change History section has three entries
    And each entry shows the issue number, date, and summary of contribution

  # --- Spec Discovery Strategy ---

  Scenario: Spec match discovery uses concrete search strategy
    Given an issue titled "Add dark mode toggle to settings"
    And the keyword extraction filters stop words "add", "to"
    When the skill searches for existing related specs
    Then it runs Glob for ".claude/specs/feature-*/requirements.md"
    And runs Grep over each candidate using keywords "dark", "mode", "toggle", "settings"
    And scores matches by total keyword hit count
    And presents the top match to the user

  # --- Amendment Content Preservation ---

  Scenario: Amendment preserves existing content
    Given a spec "feature-dark-mode" has 3 existing ACs (AC1-AC3) and 4 FRs (FR1-FR4)
    When the spec is amended with issue "#71" adding 2 new ACs and 1 new FR
    Then the existing AC1-AC3 are unchanged
    And new criteria are numbered AC4 and AC5
    And the existing FR1-FR4 are unchanged
    And the new FR is numbered FR5
    And new Gherkin scenarios are appended to feature.gherkin with "# Added by issue #71"

  # --- Migrating-Projects Consolidation ---

  Scenario: Migrating-Projects consolidates legacy specs
    Given legacy spec directories "42-add-dark-mode" and "71-dark-mode-toggle" exist
    And both contain keywords matching "dark" and "mode"
    When the user runs "/migrating-projects"
    Then the skill detects both as legacy format specs
    And clusters them as related to the same feature
    And presents a consolidation candidate: merge into "feature-dark-mode"
    And upon user confirmation, creates "feature-dark-mode" with merged content
    And the merged Issues field reads "**Issues**: #42, #71"
    And the legacy directories are removed

  Scenario: Migrating-Projects requires confirmation per consolidation
    Given consolidation candidates for "dark-mode" and "weather-alerts" are identified
    When the user approves "dark-mode" consolidation but rejects "weather-alerts"
    Then "feature-dark-mode" is created from the merged specs
    And the "weather-alerts" legacy specs are left unchanged

  Scenario: Migrating-Projects handles already-implemented specs
    Given legacy spec "42-add-dark-mode" has all tasks marked as completed
    And legacy spec "71-dark-mode-toggle" has tasks in progress
    When the specs are consolidated into "feature-dark-mode"
    Then tasks from "42-add-dark-mode" are marked as completed in the merged tasks.md
    And the Change History notes the implementation status

  # --- Cross-Reference Updates ---

  Scenario: Defect spec cross-references updated during consolidation
    Given a defect spec "bug-login-crash" has Related Spec pointing to "42-add-auth"
    And "42-add-auth" is being consolidated into "feature-add-auth"
    When consolidation completes
    Then "bug-login-crash" Related Spec field is updated to ".claude/specs/feature-add-auth/"
    And chain resolution follows Related Spec links through intermediate defect specs
    And circular references are detected via a visited set

  # --- Frontmatter Migration ---

  Scenario: Migrating-Projects updates legacy frontmatter in feature specs
    Given a feature spec "feature-dark-mode/requirements.md" exists with heading "# Requirements: Dark Mode"
    And the file contains singular "**Issue**: #42" frontmatter
    And the file has no "## Change History" section
    When the user runs "/migrating-projects"
    Then the skill detects the singular Issue field in a feature-variant spec
    And proposes updating to "**Issues**: #42"
    And proposes adding a Change History section with initial entry for "#42"
    And upon user confirmation, applies both changes
    And defect specs with "# Defect Report:" heading are left unchanged

  # --- Downstream Compatibility ---

  Scenario: Downstream skills work with new naming convention
    Given specs exist at ".claude/specs/feature-dark-mode/requirements.md"
    And the Issues frontmatter reads "**Issues**: #42, #71"
    When "/implementing-specs #42" is run
    Then the skill resolves the spec path by searching Issues frontmatter for "#42"
    And successfully reads all spec files from the feature-prefixed directory

  # --- Auto-Mode ---

  Scenario: Auto-mode skips interactive confirmations in writing-specs
    Given ".claude/auto-mode" exists in the project directory
    And "/writing-specs #71" finds a matching spec "feature-dark-mode"
    When the spec discovery step runs
    Then amendment is auto-approved without calling AskUserQuestion
    And the spec is amended with the new issue's requirements

  # Added by issue #95

  # --- Config Value Drift Detection ---

  Scenario: Drifted config values are detected and reported
    Given a project's "sdlc-config.json" has "steps.createPR.maxTurns" set to 15
    And the template "sdlc-config.example.json" has "steps.createPR.maxTurns" set to 30
    When I run "/migrating-projects"
    Then the migration summary includes a "Config Value Drift" section
    And "steps.createPR.maxTurns" is listed with current value 15 and template default 30

  Scenario: Nested step values are compared for drift
    Given a project's "sdlc-config.json" has "steps.implement.maxTurns" set to 80
    And the template "sdlc-config.example.json" has "steps.implement.maxTurns" set to 100
    And a project's "sdlc-config.json" has "steps.verify.timeoutMin" set to 20
    And the template "sdlc-config.example.json" has "steps.verify.timeoutMin" set to 20
    When I run "/migrating-projects"
    Then "steps.implement.maxTurns" is reported as drifted (80 → 100)
    And "steps.verify.timeoutMin" is not reported as drifted (values match)

  Scenario: User selects which drifted values to update
    Given the migration summary shows 3 drifted config values
    And the user is in interactive mode
    When the user is presented with a multiSelect question for drifted values
    And the user selects 2 of the 3 drifted values to update
    Then the 2 selected values are updated to template defaults in "sdlc-config.json"
    And the 1 unselected value remains unchanged

  Scenario: Approved drift updates are written and declined values preserved
    Given "steps.createPR.maxTurns" is drifted (15 → 30) and the user approves the update
    And "maxRetriesPerStep" is drifted (2 → 3) and the user declines the update
    When the migration applies changes
    Then "sdlc-config.json" has "steps.createPR.maxTurns" set to 30
    And "sdlc-config.json" has "maxRetriesPerStep" still set to 2
    And JSON formatting is preserved with 2-space indentation

  Scenario: Auto-mode reports drift but does not apply value updates
    Given ".claude/auto-mode" exists in the project directory
    And a project's "sdlc-config.json" has "steps.createPR.maxTurns" set to 15
    And the template default is 30
    When I run "/migrating-projects"
    Then the migration summary includes "steps.createPR.maxTurns: 15 → 30" in the Config Value Drift section
    And no config values are automatically updated
    And the drift is not listed in the "Skipped Operations" block
