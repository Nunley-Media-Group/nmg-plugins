# File: .claude/specs/25-add-migration-skill/feature.gherkin
#
# Generated from: .claude/specs/25-add-migration-skill/requirements.md
# Issue: #25

Feature: Project Migration Skill
  As a developer using the nmg-sdlc plugin
  I want a migration skill that updates my project's files to latest standards
  So that I benefit from new template sections without manually diffing templates

  # --- Happy Path ---

  Scenario: Steering doc migration adds missing sections
    Given a project with a "product.md" steering doc missing the "Product Principles" section
    And the latest "setting-up-steering" template includes a "Product Principles" section
    When I run "/migrating-projects"
    Then the "Product Principles" section is identified as missing
    And the section is inserted after "Core Value Proposition" with template placeholder content
    And all existing user-written content in "product.md" remains unchanged

  Scenario: Spec migration adds missing sections
    Given a project with a "requirements.md" spec missing "Non-Functional Requirements" and "UI/UX Requirements"
    And the latest "writing-specs" template includes both sections
    When I run "/migrating-projects"
    Then both missing sections are identified
    And each section is inserted at the correct position per template order
    And all existing acceptance criteria and functional requirements remain unchanged

  Scenario: User content is preserved during migration
    Given a "tech.md" steering doc with a filled-in Technology Stack table listing project-specific technologies
    And the latest template includes a new "Claude Code Resource Development" section
    When the migration adds the new section
    Then the Technology Stack table content is identical before and after migration
    And no existing content is modified or reordered

  # --- Alternative Paths ---

  Scenario: Interactive review before apply
    Given the migration analysis has identified missing sections in 3 files
    When the analysis is complete
    Then a per-file summary of proposed additions is presented
    And I can review each proposed change
    And no files are modified until I approve the migration

  Scenario: User rejects migration
    Given the migration analysis has identified proposed changes
    When I reject the migration at the review gate
    Then no files are modified
    And the skill reports that migration was cancelled

  Scenario: Self-updating template detection
    Given the plugin's "requirements.md" template has been updated with a new "Risk Assessment" section
    And the migration skill has not been modified
    When I run "/migrating-projects"
    Then the new "Risk Assessment" section is detected as missing from existing specs
    And the skill proposes adding it without any code changes to the skill itself

  Scenario: OpenClaw config migration merges missing keys
    Given a project with an "sdlc-config.json" missing the "cleanup" key and a new "merge" step
    And the latest "sdlc-config.example.json" template includes both
    When I run "/migrating-projects"
    Then the "cleanup" key is added with template default values
    And the "merge" step is added to the "steps" object
    And existing user values for "projectPath" and "discordChannelId" are preserved

  Scenario: OpenClaw skill version check warns when outdated
    Given the OpenClaw "running-sdlc" skill is installed at "~/.openclaw/skills/running-sdlc/"
    And the installed SKILL.md differs from the source in the marketplace clone
    When I run "/migrating-projects"
    Then a warning is displayed indicating the installed skill is outdated
    And the warning suggests running "/installing-openclaw-skill" to update

  # --- Edge Cases ---

  Scenario: All files already up to date
    Given all steering docs match the latest template structure
    And all spec files match the latest template structure
    And the "sdlc-config.json" has all current keys
    When I run "/migrating-projects"
    Then the skill reports "everything is up to date"
    And no files are modified

  Scenario: Missing project files are skipped
    Given a project with "product.md" but no "structure.md" in ".claude/steering/"
    And no ".claude/specs/" directory exists
    When I run "/migrating-projects"
    Then only "product.md" is analyzed for migration
    And missing files are not created
    And the summary notes that "/setting-up-steering" or "/writing-specs" can create missing files

  Scenario: Defect spec variant is correctly detected
    Given a spec directory with a "requirements.md" starting with "# Defect Report:"
    And the latest defect template variant includes a new section
    When I run "/migrating-projects"
    Then the defect template variant is used for comparison instead of the feature variant
    And the missing section from the defect variant is proposed for insertion

  Scenario: Feature spec variant is correctly detected
    Given a spec directory with a "requirements.md" starting with "# Requirements:"
    And the latest feature template includes a new section
    When I run "/migrating-projects"
    Then the feature template variant is used for comparison
    And the missing section from the feature variant is proposed for insertion
